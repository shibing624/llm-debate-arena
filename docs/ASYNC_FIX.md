# å¼‚æ­¥å¹¶å‘é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡**ï¼šæ‰“å¼€ 2 ä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µï¼ŒåŒæ—¶è¯·æ±‚ 2 ä¸ªè¾©é¢˜ï¼Œå‘ç°åªèƒ½ç­‰æŸä¸€ä¸ªæ‰§è¡Œå®Œæˆåï¼Œå¦ä¸€ä¸ªè¯·æ±‚æ‰ä¼šçœŸæ­£å¼€å§‹ï¼Œåå°æ—¥å¿—ä¹Ÿæ˜¯ä¸²è¡Œçš„ï¼Œå¹¶æ²¡æœ‰çœŸæ­£å¹¶å‘ã€‚

**é¢„æœŸ**ï¼šFastAPI æ˜¯å¼‚æ­¥æ¡†æ¶ï¼Œåº”è¯¥æ”¯æŒå¤šä¸ªè¯·æ±‚å¹¶å‘æ‰§è¡Œã€‚

## ğŸ” æ ¹æœ¬åŸå› 

### OpenAI SDK çš„åŒæ­¥é™·é˜±

```python
# âŒ é”™è¯¯ä»£ç ï¼ˆä¹‹å‰çš„å®ç°ï¼‰
from openai import OpenAI

client = OpenAI(...)

async def query_model_stream(...):
    stream = client.chat.completions.create(...)  # åŒæ­¥è°ƒç”¨
    
    for chunk in stream:  # âš ï¸ è¿™æ˜¯åŒæ­¥è¿­ä»£ï¼Œé˜»å¡äº†æ•´ä¸ªäº‹ä»¶å¾ªç¯ï¼
        yield {...}
```

**é—®é¢˜åˆ†æ**ï¼š

1. `client.chat.completions.create()` è¿”å›çš„æ˜¯**åŒæ­¥è¿­ä»£å™¨**
2. `for chunk in stream` æ˜¯**åŒæ­¥é˜»å¡**çš„
3. å³ä½¿åœ¨ `async def` ä¸­ï¼Œè¿™ä¸ªå¾ªç¯ä¹Ÿä¼š**é˜»å¡æ•´ä¸ªäº‹ä»¶å¾ªç¯**
4. å¯¼è‡´å…¶ä»–è¯·æ±‚å¿…é¡»ç­‰å¾…å½“å‰æµå¼è¾“å‡ºå®Œæˆ

### ä¸ºä»€ä¹ˆä¼šé˜»å¡ï¼Ÿ

```python
# äº‹ä»¶å¾ªç¯æ‰§è¡Œæµç¨‹
Request 1 arrives â†’ async def query_model_stream()
                 â†’ for chunk in stream:  # âš ï¸ é˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…æ‰€æœ‰ chunk
                 â†’ é‡Šæ”¾æ§åˆ¶æƒ

Request 2 arrives â†’ ç­‰å¾… Request 1 å®Œæˆ...
```

åœ¨åŒæ­¥è¿­ä»£ `for chunk in stream` æœŸé—´ï¼š
- äº‹ä»¶å¾ªç¯è¢«å ç”¨
- æ— æ³•åˆ‡æ¢åˆ°å…¶ä»–åç¨‹
- æ‰€æœ‰å¹¶å‘è¯·æ±‚éƒ½è¢«ä¸²è¡ŒåŒ–

## âœ… è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨ **AsyncOpenAI** å®¢æˆ·ç«¯ï¼š

```python
# âœ… æ­£ç¡®ä»£ç 
from openai import AsyncOpenAI

client = AsyncOpenAI(...)

async def query_model_stream(...):
    stream = await client.chat.completions.create(...)  # å¼‚æ­¥è°ƒç”¨
    
    async for chunk in stream:  # âœ… å¼‚æ­¥è¿­ä»£ï¼Œä¸é˜»å¡äº‹ä»¶å¾ªç¯
        yield {...}
```

### å…³é”®æ”¹åŠ¨

#### 1. å¯¼å…¥å¼‚æ­¥å®¢æˆ·ç«¯

```python
# backend/llm_client.py
- from openai import OpenAI
+ from openai import AsyncOpenAI

- client = OpenAI(...)
+ client = AsyncOpenAI(...)
```

#### 2. æµå¼è°ƒç”¨æ·»åŠ  await

```python
- stream = client.chat.completions.create(**request_params)
+ stream = await client.chat.completions.create(**request_params)
```

#### 3. åŒæ­¥ for æ”¹ä¸º async for

```python
- for chunk in stream:
+ async for chunk in stream:
```

#### 4. éæµå¼è°ƒç”¨ä¹Ÿè¦ await

```python
async def query_model(...):
-   response = client.chat.completions.create(...)
+   response = await client.chat.completions.create(...)
```

## ğŸ¯ æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆä¸²è¡Œï¼‰

```
[14:30:00] è¾©é¢˜ 1 å¼€å§‹
[14:30:00] è¾©é¢˜ 2 å¼€å§‹
[14:30:15] è¾©é¢˜ 1 å®Œæˆ (15ç§’)
[14:30:30] è¾©é¢˜ 2 å®Œæˆ (30ç§’)  â† ç­‰å¾…è¾©é¢˜1å®Œæˆåæ‰çœŸæ­£å¼€å§‹
æ€»è€—æ—¶: 30ç§’
```

### ä¿®å¤åï¼ˆå¹¶å‘ï¼‰

```
[14:30:00] è¾©é¢˜ 1 å¼€å§‹
[14:30:00] è¾©é¢˜ 2 å¼€å§‹         â† åŒæ—¶å¼€å§‹
[14:30:15] è¾©é¢˜ 1 å®Œæˆ (15ç§’)
[14:30:15] è¾©é¢˜ 2 å®Œæˆ (15ç§’)  â† åŒæ—¶å®Œæˆ
æ€»è€—æ—¶: 15ç§’
```

## ğŸ§ª æµ‹è¯•å¹¶å‘

ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬ï¼š

```bash
# ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨
uvicorn backend.main:app --reload --port 8000 --host 0.0.0.0

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œæµ‹è¯•
python test_concurrency.py
```

**é¢„æœŸè¾“å‡º**ï¼ˆäº¤å‰æ—¥å¿—ï¼Œè¯´æ˜å¹¶å‘æˆåŠŸï¼‰ï¼š

```
[14:30:00] è¾©é¢˜ 1 å¼€å§‹: AI æ˜¯å¦ä¼šå–ä»£äººç±»ç¨‹åºå‘˜
[14:30:00] è¾©é¢˜ 2 å¼€å§‹: è¿œç¨‹åŠå…¬æ˜¯å¦æ¯”åŠå…¬å®¤åŠå…¬æ›´é«˜æ•ˆ
[14:30:00] è¾©é¢˜ 3 å¼€å§‹: é‡å­è®¡ç®—ä¼šåœ¨10å¹´å†…æ”¹å˜ä¸–ç•Œ
[14:30:01] è¾©é¢˜ 1 å·²å¼€å§‹æµå¼è¾“å‡º
[14:30:01] è¾©é¢˜ 2 å·²å¼€å§‹æµå¼è¾“å‡º
[14:30:01] è¾©é¢˜ 3 å·²å¼€å§‹æµå¼è¾“å‡º
[14:30:15] è¾©é¢˜ 1 å®Œæˆ (è€—æ—¶: 15.2ç§’)
[14:30:16] è¾©é¢˜ 2 å®Œæˆ (è€—æ—¶: 16.1ç§’)
[14:30:17] è¾©é¢˜ 3 å®Œæˆ (è€—æ—¶: 17.3ç§’)

æ€»è€—æ—¶: 17.3 ç§’
âœ… å¹¶å‘æµ‹è¯•é€šè¿‡ï¼å¤šä¸ªè¾©é¢˜ç¡®å®åœ¨å¹¶è¡Œæ‰§è¡Œã€‚
```

## ğŸ“š æŠ€æœ¯åŸç†

### Python å¼‚æ­¥çš„ä¸¤ä¸ªå…³é”®ç‚¹

1. **async def**ï¼šå®šä¹‰åç¨‹å‡½æ•°
2. **await / async for**ï¼šè®©å‡ºæ§åˆ¶æƒï¼Œå…è®¸äº‹ä»¶å¾ªç¯è°ƒåº¦å…¶ä»–åç¨‹

### äº‹ä»¶å¾ªç¯è°ƒåº¦

```python
# æ­£ç¡®çš„å¼‚æ­¥æµå¼å¤„ç†
async def handler_1():
    async for chunk in stream_1:  # â† å¤„ç†ä¸€å°å—æ•°æ®
        yield chunk                # â† è®©å‡ºæ§åˆ¶æƒ
        # äº‹ä»¶å¾ªç¯å¯ä»¥åˆ‡æ¢åˆ° handler_2

async def handler_2():
    async for chunk in stream_2:  # â† å¤„ç†ä¸€å°å—æ•°æ®
        yield chunk                # â† è®©å‡ºæ§åˆ¶æƒ
        # äº‹ä»¶å¾ªç¯å¯ä»¥åˆ‡æ¢å› handler_1
```

äº‹ä»¶å¾ªç¯åœ¨ä¸¤ä¸ªåç¨‹é—´ä¸æ–­åˆ‡æ¢ï¼Œå®ç°å¹¶å‘ã€‚

### åŒæ­¥é˜»å¡çš„å±å®³

```python
# é”™è¯¯çš„åŒæ­¥è¿­ä»£
async def handler_1():
    for chunk in stream_1:  # âš ï¸ å®Œå…¨é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰ chunk å¤„ç†å®Œ
        yield chunk
    # å…¶ä»–åç¨‹å®Œå…¨æ— æ³•æ‰§è¡Œï¼
```

## ğŸ”§ å…¶ä»–ç±»ä¼¼é—®é¢˜æ’æŸ¥

å¦‚æœä»æœ‰ä¸²è¡Œé—®é¢˜ï¼Œæ£€æŸ¥ï¼š

### 1. æ•°æ®åº“æ“ä½œ

```python
# âŒ é”™è¯¯ï¼šåŒæ­¥æ•°æ®åº“è°ƒç”¨
def save_match(match):
    db.commit()  # é˜»å¡

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥æ•°æ®åº“è°ƒç”¨
async def save_match(match):
    await db.commit()  # ä¸é˜»å¡
```

### 2. æ–‡ä»¶ I/O

```python
# âŒ é”™è¯¯ï¼šåŒæ­¥æ–‡ä»¶è¯»å†™
with open('file.txt') as f:
    data = f.read()

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥æ–‡ä»¶è¯»å†™
async with aiofiles.open('file.txt') as f:
    data = await f.read()
```

### 3. HTTP è¯·æ±‚

```python
# âŒ é”™è¯¯ï¼šåŒæ­¥ HTTP è¯·æ±‚
import requests
response = requests.get('https://api.example.com')

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥ HTTP è¯·æ±‚
import aiohttp
async with aiohttp.ClientSession() as session:
    async with session.get('https://api.example.com') as response:
        data = await response.json()
```

## ğŸ“Š æ€§èƒ½æå‡

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| 2ä¸ªå¹¶å‘è¾©é¢˜ | 60ç§’ | 30ç§’ | **2x** |
| 5ä¸ªå¹¶å‘è¾©é¢˜ | 150ç§’ | 30ç§’ | **5x** |
| 10ä¸ªå¹¶å‘è¾©é¢˜ | 300ç§’ | 30ç§’ | **10x** |

*å‡è®¾å•ä¸ªè¾©é¢˜è€—æ—¶ 30 ç§’

## âœ… éªŒè¯æ¸…å•

- [x] ä½¿ç”¨ `AsyncOpenAI` å®¢æˆ·ç«¯
- [x] æµå¼è°ƒç”¨ä½¿ç”¨ `await` å’Œ `async for`
- [x] éæµå¼è°ƒç”¨ä½¿ç”¨ `await`
- [x] æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
- [x] æµ‹è¯•è„šæœ¬éªŒè¯å¹¶å‘æˆåŠŸ

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒæ•™è®­**ï¼šåœ¨ Python å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œä»»ä½• I/O æ“ä½œï¼ˆLLM APIã€æ•°æ®åº“ã€æ–‡ä»¶ï¼‰éƒ½å¿…é¡»ä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬ï¼Œå¦åˆ™ä¼šé˜»å¡æ•´ä¸ªäº‹ä»¶å¾ªç¯ï¼Œç ´åå¹¶å‘æ€§èƒ½ã€‚

**è®°ä½**ï¼š
- `async def` ä¸ä»£è¡¨å¼‚æ­¥æ‰§è¡Œ
- `await` å’Œ `async for` æ‰æ˜¯çœŸæ­£çš„å¼‚æ­¥
- åŒæ­¥è°ƒç”¨ = é˜»å¡äº‹ä»¶å¾ªç¯ = ä¸²è¡Œæ‰§è¡Œ

ç°åœ¨ç³»ç»Ÿå·²ç»æ”¯æŒçœŸæ­£çš„å¹¶å‘äº†ï¼ğŸ‰
